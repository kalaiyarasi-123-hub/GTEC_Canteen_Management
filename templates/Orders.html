<!DOCTYPE html>
<html>
<head>
<title>Daily Orders</title>

<style>
body{
    font-family:Arial;
    background:#f4f4f4;
    padding:20px
}
.order{
    background:#fff;
    padding:12px;
    border-radius:10px;
    margin-top:10px;
    box-shadow:0 2px 5px rgba(0,0,0,0.1);
}
.items{
    margin-left:15px;
    font-size:14px
}
.no-orders{
    margin-top:10px;
    color:#555
}
h2{
    margin-bottom:15px;
}
</style>
</head>

<body>

<h2>Daily Orders</h2>

<!-- ðŸ”” Notification Sound -->
<audio id="orderSound" src="{{ url_for('static', filename='sounds/notification.mp3') }}"></audio>

<div id="orders"></div>

<script>

let lastOrderIds = [];

// ðŸ”“ Unlock sound after first click (browser autoplay restriction fix)
document.body.addEventListener("click", function(){
    const audio = document.getElementById("orderSound");
    audio.play().then(() => {
        audio.pause();
        audio.currentTime = 0;
    }).catch(()=>{});
}, { once:true });

function playSound(){
    const audio = document.getElementById("orderSound");
    audio.play().catch(()=>{});
}

function renderOrders(){

    fetch("/get_orders")
    .then(res => res.json())
    .then(orders => {

        const div = document.getElementById("orders"); 
        div.innerHTML = "";

        if(!orders || orders.length === 0){
            div.innerHTML = `<div class="no-orders">No orders yet</div>`;
            return;
        }

        // ðŸ”¥ Detect new order using orderId
        let currentIds = orders.map(o => o.orderId);

        if(lastOrderIds.length > 0){
            let newOrders = currentIds.filter(id => !lastOrderIds.includes(id));
            if(newOrders.length > 0){
                playSound();
                alert("ðŸ”” New Order Received!");
            }
        }

        lastOrderIds = currentIds;

        // Show latest first
        orders.reverse().forEach((o, index) => {

            let itemsHTML = "";

            try {
                let parsedItems = JSON.parse(o.items.replace(/'/g,'"'));
                parsedItems.forEach(i => {
                    itemsHTML += `<li>${i.name} x ${i.quantity}</li>`;
                });
            } catch(e){
                itemsHTML = "<li>Error loading items</li>";
            }

            div.innerHTML += `
            <div class="order">
                <b>Serial No:</b> ${index + 1}<br>
                <b>Order ID:</b> ${o.orderId}<br>
                <b>Date:</b> ${o.date}<br>
                <b>Total:</b> Rs ${o.total}<br>
                <b>Status:</b> ${o.status}
                <ul class="items">${itemsHTML}</ul>
            </div>`;
        });

    })
    .catch(err => console.log("Error loading orders:", err));
}

renderOrders();
setInterval(renderOrders, 3000);

</script>

</body>
</html>
